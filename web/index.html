<html>

<head>
  <link rel="stylesheet" type="text/css" href="boxscore.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
  <script src="pie.js"></script>
  <script src="boxscore.js"></script>
  <script src="playbyplay.js"></script>
  <script src="schedule.js"></script>
  <script src="teams.js"></script>
  <script src="util.js"></script>

  <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/redmond/jquery-ui.css">
  <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

  <script>
    //schedule
    var sched = new schedule()
      .id("schedule")
      .getschedule();

    var gameID = "0041400406";//finals agme 6
    //var gameID = "0021400962"; //1OT
    //var gameID = "0021400491";
    //var gameID = "0041400123"; //2OT
    var mainurl = window.location.href;
    if(mainurl.indexOf("gameid") > -1) {
      gameID = mainurl.substring(mainurl.indexOf("gameid")+7);
    }

    var homeTeam = {};
    var awayTeam = {};
    var neutral = {};

    var pbp = new playbyplay();
    $.ajax({
        type : 'POST',
        url : 'http://eaganr.com:3000',           
        data: {
          func: "getBoxScore",
          gameID : gameID
        },
        success:function (data) {
          data = data.resultSets;
          console.log(data);
           
          homeTeam.id = data[1].rowSet[0][3];
          awayTeam.id = data[1].rowSet[1][3];
          homeTeam.abbrev = data[1].rowSet[0][4];
          awayTeam.abbrev = data[1].rowSet[1][4];
          homeTeam.color = teamcolors(homeTeam.abbrev);
          awayTeam.color = teamcolors(awayTeam.abbrev, homeTeam.color);
          homeTeam.score = data[5].rowSet[0][23];
          awayTeam.score = data[5].rowSet[1][23];

          document.getElementById("hometeam").getElementsByTagName("h1")[0].innerHTML=homeTeam.abbrev+" - "+homeTeam.score;
          document.getElementById("awayteam").getElementsByTagName("h1")[0].innerHTML=awayTeam.score+" - "+awayTeam.abbrev;

          homeTeam.players = [];
          awayTeam.players = [];
          for(var i=0;i<data[4].rowSet.length;i++) {
            var player = data[4].rowSet[i];
            if(player[1] === homeTeam.id) {
              homeTeam.players.push(player);
            }
            if(player[1] === awayTeam.id) {
              awayTeam.players.push(player);
            }
          }

          homeTeam.scoring = new pie("#homescoring")
            .w(250).h(250)
            .value("26")
            .data(homeTeam.players)
            .diff("4")
            .label(function(d) { return d.data["5"].split(" ")[1]+" - "+d.data["26"];})
            .title(homeTeam.abbrev + " Scoring")
            .draw();  

          awayTeam.scoring = new pie("#awayscoring")
            .w(250).h(250)
            .value("26")
            .data(awayTeam.players)
            .diff("4")
            .label(function(d) { return d.data["5"].split(" ")[1]+" - "+d.data["26"];})
            .title(awayTeam.abbrev + " Scoring")
            .draw();

          //boxscore
          homeTeam.box = new boxscore("homebox",homeTeam.players);
          awayTeam.box = new boxscore("awaybox",awayTeam.players);

          var homeRebs = [
            {abbrev:homeTeam.abbrev, reb:data[5].rowSet[0][16]},
            {abbrev:awayTeam.abbrev, reb:data[5].rowSet[1][15]}
          ];
          var awayRebs = [
            {abbrev:awayTeam.abbrev, reb:data[5].rowSet[1][16]},
            {abbrev:homeTeam.abbrev, reb:data[5].rowSet[0][15]}
          ];

          homeTeam.rebounds = new pie("#homerebounding")
            .w(250).h(250)
            .value("reb")
            .data(homeRebs)
            .diff("abbrev")
            .label(function(d) { return d.data.abbrev+" - "+d.data.reb;})
            .color(teamcolors, true)
            .title(homeTeam.abbrev + " Basket Rebounds")
            .draw();

          awayTeam.rebounds = new pie("#awayrebounding")
            .w(250).h(250)
            .value("reb")
            .data(awayRebs)
            .diff("abbrev")
            .label(function(d) { return d.data.abbrev+" - "+d.data.reb;})
            .color(teamcolors, true)
            .title(awayTeam.abbrev + " Basket Rebounds")
            .draw();

          var threes = [
            {abbrev:homeTeam.abbrev, threes:data[5].rowSet[0][9]},
            {abbrev:awayTeam.abbrev, threes:data[5].rowSet[1][9]}
          ];
          var fouls = [
            {abbrev:homeTeam.abbrev, fls:data[5].rowSet[0][22]},
            {abbrev:awayTeam.abbrev, fls:data[5].rowSet[1][22]}
          ];
          var assists = [
            {abbrev:homeTeam.abbrev, assists:data[5].rowSet[0][18]},
            {abbrev:awayTeam.abbrev, assists:data[5].rowSet[1][18]}
          ];
          var tos = [
            {abbrev:homeTeam.abbrev, to:data[5].rowSet[0][21]},
            {abbrev:awayTeam.abbrev, to:data[5].rowSet[1][21]}
          ];


          neutral.threes = new pie("#threes")
            .w(250).h(250)
            .value("threes")
            .data(threes)
            .diff("abbrev")
            .label(function(d) { return d.data.abbrev+" - "+d.data.threes;})
            .color(teamcolors, true)
            .title("3 Point FGM")
            .draw();

          neutral.fouls = new pie("#fouls")
            .w(250).h(250)
            .value("fls")
            .data(fouls)
            .diff("abbrev")
            .label(function(d) { return d.data.abbrev+" - "+d.data.fls;})
            .color(teamcolors, true)
            .title("Fouls")
            .draw();

          neutral.tos = new pie("#tos")
            .w(250).h(250)
            .value("to")
            .data(tos)
            .diff("abbrev")
            .label(function(d) { return d.data.abbrev+" - "+d.data.to;})
            .color(teamcolors, true)
            .title("TOs")
            .draw();

          neutral.assists = new pie("#assists")
            .w(250).h(250)
            .value("assists")
            .data(assists)
            .diff("abbrev")
            .label(function(d) { return d.data.abbrev+" - "+d.data.assists;})
            .color(teamcolors, true)
            .title("Assists")
            .draw();

        $.ajax({
            type : 'POST',
            url : 'http://eaganr.com:3000',           
            data: {
              func: "getPlayByPlay",
              gameID : gameID
            },
            success:function (data) {
              console.log(data);
              var homeplayers = homeTeam.players.map(function(d) { return d[5].split(" ")[d[5].split(" ").length -1]; });
              var awayplayers = awayTeam.players.map(function(d) { return d[5].split(" ")[d[5].split(" ").length -1]; });

              //same name players
              var allplayers = [homeplayers, awayplayers];
              var allteams = [homeTeam, awayTeam];
              for(var t=0;t<2;t++) {
                var players = allplayers[t];
                for(var i=0;i<players.length;i++) {                                      
                  if(players[i] === "III") {                                             
                    players[i] = "Lucas III";                                            
                  }                                                                          
                  for(var j=0;j<players.length;j++) {                                    
                    if(i !== j) {                                                            
                      var n=0;                                                               
                      var p1 = "";                                                           
                      var p2 = "";                                                           
                      while(p1 + " " + players[i] === p2 + " " + players[j]) {       
                        p1 = p1 + allteams[t].players[i][5].substring(n,n+1);           
                        p2 = p2 + allteams[t].players[j][5].substring(n,n+1);           
                        n++;                                                                 
                      }                                                                      
                      if(p1.length === 1) {                                                  
                        players[i] = p1 + ". " + players[i];                         
                        players[j] = p2 + ". " + players[j];                         
                      }                                                                      
                      if(p1.length > 1) {                                                    
                        players[i] = p1 + " " + players[i];                          
                        players[j] = p2 + " " + players[j];                          
                      }                                                                      
                    }
                  }                                                                        
                }                                                                          
              }


              pbp.homeplayers(homeplayers)
                .awayplayers(awayplayers)
                .selector("#chart")
                .data(data.playByPlay)
                .parse()
                .homecolor(homeTeam.color)
                .awaycolor(awayTeam.color)
                .draw();

          }
        });
        }
      });


  </script>


</head>

<body>
  <div class="content">  
    <div id="schedule"></div>

    <h1>Play By Play</h1>
    <svg id="chart" width="1050" height="550"></svg>

    <h1>Stats</h1>
    <div class="stats">
      <div class="pie" id="threes"></div>
      <div class="pie" id="fouls"></div>
      <div class="pie" id="assists"></div>
      <div class="pie" id="tos"></div>
    </div>

    <div class="team" id="hometeam">
      <h1></h1>
      <div class="charts">
        <div class="pie" id="homescoring"></div>
        <div class="pie" id="homerebounding"></div>
      </div>
      <div class="boxscore" id="homebox"></div>
    </div>
    <div class="team" id="awayteam">
      <h1></h1>
      <div class="charts">
        <div class="pie" id="awayscoring"></div>
        <div class="pie" id="awayrebounding"></div>
      </div>
      <div class="boxscore" id="awaybox"></div>
    </div>
  </div>
</body>

</html
